
#requires -modules hp.firmware

[cmdletbinding()]
param()


# signed payload packages to import:

$KEKData = '{"timestamp":"2025-03-24T14:25:49.2340412-07:00","purpose":"hp:provision:endorsementkey","Data":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,48,130,3,191,48,130,2,167,160,3,2,1,2,2,20,68,203,192,47,170,99,11,199,237,115,139,59,76,154,40,163,34,114,38,233,48,13,6,9,42,134,72,134,247,13,1,1,11,5,0,48,111,49,11,48,9,6,3,85,4,6,19,2,85,83,49,11,48,9,6,3,85,4,8,12,2,65,90,49,15,48,13,6,3,85,4,7,12,6,84,117,99,115,111,110,49,23,48,21,6,3,85,4,10,12,14,68,101,112,108,111,121,109,101,110,116,76,105,118,101,49,12,48,10,6,3,85,4,11,12,3,68,101,118,49,27,48,25,6,3,85,4,3,12,18,68,101,112,108,111,121,109,101,110,116,76,105,118,101,46,99,111,109,48,30,23,13,50,53,48,51,50,52,50,49,50,53,52,57,90,23,13,51,53,48,51,50,50,50,49,50,53,52,57,90,48,111,49,11,48,9,6,3,85,4,6,19,2,85,83,49,11,48,9,6,3,85,4,8,12,2,65,90,49,15,48,13,6,3,85,4,7,12,6,84,117,99,115,111,110,49,23,48,21,6,3,85,4,10,12,14,68,101,112,108,111,121,109,101,110,116,76,105,118,101,49,12,48,10,6,3,85,4,11,12,3,68,101,118,49,27,48,25,6,3,85,4,3,12,18,68,101,112,108,111,121,109,101,110,116,76,105,118,101,46,99,111,109,48,130,1,34,48,13,6,9,42,134,72,134,247,13,1,1,1,5,0,3,130,1,15,0,48,130,1,10,2,130,1,1,0,183,114,209,182,6,135,143,68,158,131,86,197,117,175,174,0,190,249,58,250,142,200,63,23,247,84,26,57,68,154,96,93,227,4,196,32,152,147,200,189,129,56,212,132,196,107,171,189,227,21,64,92,63,35,251,244,80,91,178,168,153,53,63,53,123,185,136,246,186,236,128,255,38,83,203,140,187,240,157,159,126,209,154,114,122,198,13,34,129,18,192,159,167,101,171,128,34,137,75,116,72,170,148,126,181,246,65,38,60,229,118,67,123,172,97,205,75,94,46,249,217,149,5,124,8,160,10,84,126,68,139,166,64,193,9,228,203,99,213,57,109,77,238,209,167,26,221,112,172,24,5,233,61,30,29,202,26,134,254,62,197,139,87,156,78,1,189,165,103,215,154,65,152,82,11,142,147,107,88,211,65,229,203,109,171,139,199,149,245,140,184,158,57,25,140,72,78,214,232,2,55,171,245,161,189,183,25,186,174,250,185,97,69,237,117,197,230,95,210,84,206,154,74,12,67,1,242,172,63,190,153,66,139,67,93,207,133,34,164,85,207,3,243,212,231,50,203,192,136,73,27,213,153,181,224,63,2,3,1,0,1,163,83,48,81,48,29,6,3,85,29,14,4,22,4,20,94,245,132,67,184,63,114,241,240,241,6,174,150,137,36,244,194,203,2,141,48,31,6,3,85,29,35,4,24,48,22,128,20,94,245,132,67,184,63,114,241,240,241,6,174,150,137,36,244,194,203,2,141,48,15,6,3,85,29,19,1,1,255,4,5,48,3,1,1,255,48,13,6,9,42,134,72,134,247,13,1,1,11,5,0,3,130,1,1,0,12,238,239,90,220,197,97,75,149,33,119,184,245,202,103,140,247,148,222,87,252,89,86,249,62,170,88,213,102,43,216,59,91,237,141,11,155,131,185,184,203,89,10,133,115,148,126,237,10,220,217,154,110,222,221,164,163,226,24,240,105,27,25,53,156,17,181,63,65,155,46,166,246,62,238,118,64,221,3,223,62,89,254,234,85,24,173,27,113,243,197,29,127,173,68,77,157,28,216,255,92,182,13,19,116,101,233,29,107,35,140,15,194,218,62,110,141,22,19,112,42,22,110,0,49,77,216,232,241,143,253,236,150,55,38,237,144,69,169,6,33,223,155,127,44,196,163,199,30,104,235,152,181,163,69,222,105,83,184,231,104,251,238,252,208,56,7,50,26,173,17,136,26,129,27,198,21,230,146,186,165,249,232,70,56,200,157,127,224,84,80,206,223,46,178,161,29,168,248,55,68,137,93,158,188,84,112,152,132,247,121,56,3,53,62,22,93,115,73,101,205,231,94,61,135,234,174,221,216,85,46,237,30,87,96,216,133,42,192,117,220,135,211,106,211,104,251,143,245,212,225,214,56,111,107,120],"Meta1":null,"Meta2":null,"Meta3":null,"Meta4":null}'
$SKData = '{"timestamp":"2025-03-24T14:25:49.9372448-07:00","purpose":"hp:provision:signingkey","Data":[0,174,198,169,185,245,113,156,59,243,105,52,213,38,38,36,168,120,21,49,74,239,244,214,92,102,131,213,245,249,246,241,188,4,204,181,127,28,198,158,236,146,234,106,88,115,159,234,181,161,68,250,199,6,71,131,167,52,246,85,131,208,201,202,124,109,62,53,132,46,47,49,42,209,15,203,162,146,202,111,226,171,24,76,174,150,27,200,219,150,245,120,82,177,21,36,127,15,194,148,248,189,249,93,149,178,93,241,20,80,167,172,167,55,209,136,16,223,2,45,67,69,113,255,178,214,92,152,243,131,141,254,109,87,172,46,238,72,127,200,44,251,194,175,185,254,195,59,235,110,20,35,56,97,41,205,93,34,116,165,134,60,110,226,97,114,179,21,135,30,25,204,180,70,243,59,208,145,203,10,165,180,207,106,63,183,202,78,245,209,198,169,155,98,131,47,213,34,146,48,73,65,164,119,30,89,94,33,139,233,71,229,85,8,169,163,172,42,136,188,205,238,239,159,71,249,67,202,66,142,142,134,205,202,108,243,115,24,2,94,189,64,180,70,240,163,115,112,54,232,243,151,44,242,71,127,222,205,225,103,219,164,54,168,176,22,90,52,219,4,162,111,147,234,56,186,174,126,66,150,72,244,231,114,99,132,247,164,176,220,135,192,123,70,187,162,123,110,179,9,108,236,60,55,249,227,218,177,172,249,56,51,175,180,52,134,124,177,237,122,212,240,166,60,101,203,17,94,180,33,133,249,179,22,10,23,151,166,243,132,213,193,187,112,99,65,45,247,160,53,197,252,123,237,180,20,224,72,108,26,147,154,207,212,15,118,240,239,82,64,228,229,14,73,123,5,143,38,119,66,149,196,254,106,54,229,136,196,209,204,13,111,61,131,113,98,34,168,150,38,215,213,252,227,9,29,170,174,207,156,220,70,227,31,88,234,69,252,71,245,249,214,198,189,40,220,21,51,255,135,195,53,184,51,197,230,225,155,167,6,227,88,130,17,9,66,33,217,189,132,185,185,172,200,113,188,182,253,7,151,179,216,26,216,51,85,149,149,177,159,46,218,34,141,115,108,177,206,159,217,53,225,48,214,92,249,131,35,232,87,66,68,50,175,148,142,37,52,15,88,3,31,109,56,63,33,186,252,123,212,87,145,145,7,112,200],"Meta1":null,"Meta2":null,"Meta3":null,"Meta4":null}'
$REData = '{"timestamp":"2025-04-22T15:15:08.2672147-07:00","purpose":"hp:surerecover:provision:recovery_image","Data":[36,61,163,114,131,92,57,247,136,177,138,156,179,233,78,70,137,131,252,219,49,198,137,131,47,190,112,13,140,140,160,41,65,61,13,19,165,219,62,119,168,178,128,99,64,175,145,245,96,240,41,34,175,171,66,230,88,206,174,104,120,253,83,45,76,144,223,189,95,145,144,18,203,107,218,67,81,244,28,252,146,163,122,97,26,71,43,241,160,182,82,231,134,50,82,244,62,13,33,64,130,253,123,153,108,191,75,189,235,225,116,19,44,104,162,109,127,229,202,243,93,129,1,2,66,11,249,172,254,245,91,99,182,229,60,241,159,196,188,6,140,215,232,129,10,54,214,102,8,244,66,7,13,76,208,101,48,55,201,192,194,27,123,159,142,153,141,25,119,204,200,199,59,245,69,162,101,113,153,17,98,47,9,65,96,223,140,28,88,125,42,9,88,21,215,236,101,143,83,61,123,249,108,76,234,90,192,86,232,88,128,255,84,210,174,128,149,14,248,72,185,11,1,130,158,126,177,226,119,254,255,128,217,30,78,144,196,91,80,52,159,105,19,57,44,188,141,3,100,96,135,189,174,228,125,192,236,20,8,104,1,0,159,176,161,145,26,37,255,57,167,63,165,181,22,24,240,239,214,209,86,115,22,190,26,174,134,207,89,63,207,162,196,178,212,128,143,243,59,161,227,7,164,1,223,98,231,214,77,104,189,170,69,1,15,24,34,15,216,153,120,96,204,220,76,97,131,16,78,33,91,103,242,35,221,160,224,225,135,48,168,47,94,178,164,175,196,157,245,63,53,124,226,185,108,108,23,161,229,186,70,174,252,83,249,106,6,68,67,197,218,213,35,11,210,70,116,224,37,46,194,68,11,5,114,125,247,99,239,3,111,102,168,181,240,120,127,78,228,249,53,120,230,166,104,228,75,39,173,34,122,98,117,184,30,13,150,41,171,249,165,157,22,127,223,252,162,59,14,122,136,29,160,202,66,213,90,115,197,220,203,236,23,157,248,88,234,8,32,193,55,168,147,167,66,242,106,119,107,219,97,240,66,78,254,7,223,24,9,145,55,62,121,50,35,214,209,179,100,182,57,17,98,45,170,181,174,248,251,254,92,57,112,254,29,156,14,208,4,121,111,170,220,178,2,234,121,80,106,12,240,131,167,23,213,4,0,174,0,0,104,116,116,112,58,47,47,98,111,111,116,46,100,101,112,108,111,121,109,101,110,116,108,105,118,101,46,99,111,109,47,104,112],"Meta1":null,"Meta2":null,"Meta3":null,"Meta4":null}'


$ErrorActionPreference = 'stop'

# Provision the KEK and SK

$State = Get-HPSecurePlatformState
$State | out-string | write-verbose
if ( $State.State -ne "Provisioned" ) { 
    write-verbose "Needs provisoining"

    if ( $State.EndorsementKeyMod | measure -sum | ? Sum -eq 0 ) { 
        write-verbose "Load Endorsement Key"
        Set-HPSecurePlatformPayload -Payload $kekData
    }

    if ( $State.SigningKeyMod | measure -sum | ? Sum -eq 0 ) { 
        write-verbose "Load Signing Key"
        Set-HPSecurePlatformPayload -Payload $SKData
    }

}

# Provision the Recovery State. Always write.

$RecoverState = Get-HPSureRecoverState -all 
$RecoverState | out-string | write-verbose

Set-HPSecurePlatformPayload -Payload $REData

$RecoverState = Get-HPSureRecoverState -all 
$RecoverState | out-string | write-verbose

# Must Reboot?

$State = Get-HPSecurePlatformState
$State | out-string | write-verbose
if ( $state.State -ne "ProvisioningInProgress" ) { 
    write-verbose "Must Reboot"
    # read-host "Press enter to reboot"
    # shutdown -r -f -t 30
    exit 3010
}

